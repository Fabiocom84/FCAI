<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Analisi - Segretario AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="js/libs/chart.min.js"></script>
    <link rel="stylesheet" href="style-v2.css">
    <link rel="stylesheet" href="dashboard.css">
</head>

<body>

    <div class="std-app-shell">

        <!-- HEADER STANDARD -->
        <header class="std-app-header">
            <!-- SX: Home -->
            <a href="index.html" class="header-button" style="width: 80px;">
                <img src="img/log-out.png" alt="Home"
                    style="transform: rotate(180deg); filter: brightness(0) invert(1); width: 14px;">
                <span>Home</span>
            </a>

            <!-- CN: Titolo -->
            <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
                <h1 style="margin: 0; font-size: 1.2rem; color: #ffffff; text-transform: uppercase;">DASHBOARD ANALISI
                </h1>
            </div>

            <!-- DX: Switch Mode -->
            <div style="width: 80px; display: flex; justify-content: flex-end;">
                <div class="mode-switch">
                    <button class="mode-btn active" id="btnModeInbox" data-value="0">DA VALIDARE</button>
                    <button class="mode-btn" id="btnModeArchive" data-value="1">ARCHIVIO</button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT (Senza Padding, gestito internamente) -->
        <main class="std-app-content no-padding">
            <div class="dashboard-body-wrapper">

                <!-- SIDEBAR -->
                <aside class="control-sidebar">

                    <!-- DATE -->
                    <div class="sidebar-section" id="dateFilterSection">
                        <h3>Periodo</h3>
                        <div class="date-filter-container">
                            <div class="date-inputs-col">
                                <input type="date" id="dateStart" class="sidebar-input-compact"
                                    title="Data Inizio (Vuoto = Tutto)">
                                <input type="date" id="dateEnd" class="sidebar-input-compact"
                                    title="Data Fine (Vuoto = Tutto)">
                            </div>
                            <button id="btnRefresh" class="btn-icon-refresh" title="Aggiorna Dati">üîÑ</button>
                        </div>
                    </div>

                    <!-- RESET FILTERS -->
                    <div style="padding: 0 15px 10px 15px;">
                        <button id="btnResetFilters" class="btn-reset-filters" title="Ripristina vista predefinita">
                            üóëÔ∏è RESET FILTRI
                        </button>
                    </div>

                    <!-- FILTRI RAPIDI -->
                    <div class="sidebar-section grow-section">
                        <h3>Filtri Rapidi</h3>
                        <div class="filter-accordion">
                            <div class="filter-box" id="boxCommesse"></div>
                            <div class="filter-box" id="boxMacro"></div>
                            <div class="filter-box" id="boxLavorazioni"></div>
                            <div class="filter-box" id="boxDipendenti"></div>
                        </div>
                    </div>

                    <div class="sidebar-footer">
                        <button id="btnContabilizza" class="btn-primary-large">‚úÖ CONTABILIZZA</button>
                    </div>
                </aside>

                <!-- MAIN CONTENT -->
                <div class="main-content">

                    <!-- TOP BAR -->
                    <div class="view-tabs-container">
                        <div class="tabs-left">
                            <!-- VISTA DETTAGLIO ATTIVA DI DEFAULT -->
                            <button class="tab-btn" data-target="view-summary">üìä VISTA SINTESI</button>
                            <button class="tab-btn active" data-target="view-detail">üìã VISTA DETTAGLIO</button>
                        </div>

                        <div class="grouping-controls">
                            <!-- Link Registro Ordini -->
                            <a href="registro-ordini.html"
                                onclick="window.open(this.href, 'RegistroOrdiniWin', 'width=1400,height=900,resizable=yes'); return false;"
                                class="btn-small"
                                style="background: #e3f2fd; color: #1976d2; border-color: #bbdefb; text-decoration: none; display: flex; align-items: center; justify-content: center; height: 32px; margin-right: 15px;">
                                Registro Ordini ‚Üó
                            </a>

                            <span class="grouping-label">Raggruppa Per:</span>
                            <select id="groupingSelect" class="grouping-select">
                                <option value="commessa" selected>üìÇ Commessa</option>
                                <option value="macro">üèóÔ∏è Macrocategoria</option>
                                <option value="lavorazione">üîß Lavorazione</option>
                                <option value="personale">üë§ Dipendente</option>
                            </select>
                        </div>
                    </div>

                    <!-- dashboard.html (Parte VISTA SINTESI aggiornata) -->

                    <!-- VISTA SINTESI (Nascosta) -->
                    <div id="view-summary" class="view-panel">

                        <!-- KPI CARDS -->
                        <div class="kpi-row">
                            <div class="kpi-card blue">
                                <h3>Ore Totali</h3><span id="kpiTotalHours">0.0</span>
                            </div>
                            <div class="kpi-card orange">
                                <h3>Da Contabilizzare</h3><span id="kpiPending">0</span>
                            </div>
                            <div class="kpi-card green">
                                <h3>Contabilizzate</h3><span id="kpiDone">0</span>
                            </div>
                        </div>

                        <!-- RIGA 1: COMMESSE + TEMPO -->
                        <div class="analysis-row">
                            <div class="chart-box">
                                <h4>Distribuzione per Commessa</h4>
                                <div class="chart-wrapper"><canvas id="chartCommessaPie"></canvas></div>
                            </div>
                            <div class="chart-box">
                                <h4>Andamento Temporale (Ore/Mese)</h4>
                                <div class="chart-wrapper"><canvas id="chartTimeBar"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 2: LAVORAZIONI -->
                        <div class="analysis-row">
                            <div class="chart-box">
                                <h4>Distribuzione per Lavorazione</h4>
                                <div class="chart-wrapper"><canvas id="chartLavPie"></canvas></div>
                            </div>
                            <div class="chart-box">
                                <h4>Top 8 Lavorazioni (Ore)</h4>
                                <div class="chart-wrapper"><canvas id="chartLavBar"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 3: MACROCATEGORIE -->
                        <div class="analysis-row">
                            <div class="chart-box">
                                <h4>Distribuzione per Macrocategoria</h4>
                                <div class="chart-wrapper"><canvas id="chartMacroPie"></canvas></div>
                            </div>
                            <div class="chart-box">
                                <h4>Top 8 Macrocategorie (Ore)</h4>
                                <div class="chart-wrapper"><canvas id="chartMacroBar"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 4: DIPENDENTI -->
                        <div class="analysis-row">
                            <div class="chart-box">
                                <h4>Distribuzione per Dipendente</h4>
                                <div class="chart-wrapper"><canvas id="chartUserPie"></canvas></div>
                            </div>
                            <div class="chart-box">
                                <h4>Top 8 Dipendenti (Ore)</h4>
                                <div class="chart-wrapper"><canvas id="chartUserBar"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 5: CROSS DATA (Lavorazioni x Dipendente) -->
                        <div class="analysis-row full-width">
                            <div class="chart-box">
                                <h4>Top 8 Lavorazioni per Dipendente (Stacked)</h4>
                                <div class="chart-wrapper large"><canvas id="chartCrossLavUser"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 6: CROSS DATA (Macro x Dipendente) -->
                        <div class="analysis-row full-width">
                            <div class="chart-box">
                                <h4>Top 8 Macrocategorie per Dipendente (Stacked)</h4>
                                <div class="chart-wrapper large"><canvas id="chartCrossMacroUser"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 7: ANALISI ECONOMICA (Stima 45‚Ç¨/h) -->
                        <div class="analysis-row full-width">
                            <div class="chart-box">
                                <h4>üí∞ Costificazione Commesse (Basata su Costo Orario Ruolo)</h4>
                                <div class="chart-wrapper large"><canvas id="chartCostCommessa"></canvas></div>
                            </div>
                        </div>

                        <!-- RIGA 8: ANALISI HR (ASSENZE & PERMESSI) -->
                        <div class="analysis-row">
                            <div class="chart-box">
                                <h4>üèñÔ∏è Assenze per Dipendente (Ferie/Permessi/Malattia)</h4>
                                <div class="chart-wrapper"><canvas id="chartAbsenceUser"></canvas></div>
                            </div>
                            <div class="chart-box">
                                <h4>üìÖ Trend Assenze (Ore per Mese)</h4>
                                <div class="chart-wrapper"><canvas id="chartAbsenceTrend"></canvas></div>
                            </div>
                        </div>

                    </div>

                    <!-- VISTA DETTAGLIO (Attiva) -->
                    <div id="view-detail" class="view-panel active">
                        <div class="detail-toolbar">
                            <input type="text" id="detailSearch" placeholder="üîç Cerca veloce..." class="search-input">
                            <div class="toolbar-actions">
                                <button class="btn-small" id="btnExpandAll">Espandi Tutto</button>
                                <button class="btn-small" id="btnCollapseAll">Chiudi Tutto</button>
                            </div>
                        </div>
                        <div class="data-grid-container" id="dataGridContainer">
                            <div class="placeholder-msg">Caricamento dati in corso...</div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="main-footer-status">
                        <div class="status-left"><span id="statusMsg">Pronto</span></div>
                        <div class="status-right">
                            <span class="status-item">Righe: <b id="selCount">0</b></span>
                            <span class="status-item">Totale Ore Selezionate: <b id="selHours">0.0</b> h</span>
                        </div>
                    </div>

        </main>
    </div>
    </div>

    <!-- MODALE CONFERMA (Classe Custom per evitare conflitti) -->
    <div id="confirmModal" class="custom-dashboard-modal" style="display: none;">
        <div class="cdm-content">
            <div class="cdm-header">
                <h3>Conferma Operazione</h3>
                <span class="close-button" id="closeConfirmModal">&times;</span>
            </div>
            <div class="cdm-body">
                <p>Stai per contabilizzare e bloccare le seguenti registrazioni:</p>
                <div class="confirm-summary-box">
                    <div class="summary-row"><span>Righe selezionate:</span><strong id="confCount">0</strong></div>
                    <div class="summary-row"><span>Totale Ore:</span><strong id="confHours"
                            style="color:#2980b9;">0.0</strong></div>
                </div>
                <p class="warning-text">‚ö†Ô∏è <strong>Attenzione:</strong> Una volta contabilizzate, le righe passeranno in
                    "Archivio" e non saranno pi√π modificabili da questa vista.</p>
            </div>
            <div class="cdm-footer">
                <button id="btnCancelConfirm" class="btn-secondary">Annulla</button>
                <button id="btnProceedConfirm" class="btn-confirm-action">CONFERMA</button>
            </div>
        </div>
    </div>

    <!-- MODALE EDIT (Classe Custom) -->
    <div id="custom-modal-overlay" class="custom-dashboard-modal" style="display: none;">
        <div id="custom-modal" class="cdm-content">
            <h2 id="custom-modal-title" class="cdm-header-title">Modifica</h2>
            <div id="custom-modal-message" class="cdm-body"></div>
            <div id="custom-modal-buttons" class="cdm-footer"></div>
        </div>
    </div>

    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/auth-guard.js"></script>
    <script type="module" src="js/api-client.js"></script>
    <script type="module" src="js/shared-ui.js"></script>
    <script type="module" src="js/dashboard.js"></script>

</body>

</html>